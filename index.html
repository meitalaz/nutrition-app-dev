<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JudoNutrition - מערכת ליווי תזונתי לספורטאי ג'ודו</title>
    
    <!-- PWA Support -->
    <meta name="theme-color" content="#1a237e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="JudoNutrition">
    
    <!-- CSS -->
    <style>
        :root {
            --primary-blue: #1a237e;
            --primary-teal: #26a69a;
            --success-green: #66bb6a;
            --warning-orange: #ffcc02;
            --danger-red: #e53935;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Assistant', system-ui, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.5;
            direction: rtl;
        }

        .app-container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--white);
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* Screen Management */
        .screen {
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .hidden {
            display: none !important;
        }

        /* Header Styles */
        .screen-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-teal) 100%);
            color: var(--white);
            padding: 30px 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 0 0 20px 20px;
            text-align: center;
        }

        .screen-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .screen-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        /* Welcome Screen */
        .welcome-content {
            text-align: center;
            padding: 60px 20px;
        }

        .app-logo {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--gray-500);
            margin-bottom: 40px;
        }

        .role-selection {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 40px;
        }

        .role-btn {
            background: var(--white);
            border: 2px solid var(--primary-blue);
            color: var(--primary-blue);
            padding: 20px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .role-btn:hover {
            background: var(--primary-blue);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
        }

        /* Metric Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-teal) 100%);
            color: var(--white);
            padding: 24px 16px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.2);
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
        }

        .metric-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .progress-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-green) 0%, var(--primary-teal) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Cards */
        .card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-100);
        }

        /* Daily Tasks */
        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
            font-weight: 500;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-status {
            font-size: 18px;
        }

        /* Alerts */
        .alert {
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-weight: 500;
            border: 1px solid;
        }

        .alert-success {
            background: #e8f5e8;
            border-color: var(--success-green);
            color: #2e7d32;
        }

        .alert-warning {
            background: #fff3e0;
            border-color: var(--warning-orange);
            color: #e65100;
        }

        .alert-danger {
            background: #ffebee;
            border-color: var(--danger-red);
            color: #c62828;
        }

        .alert-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* Buttons */
        .btn {
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-teal) 100%);
            color: var(--white);
            box-shadow: 0 2px 8px rgba(26, 35, 126, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary-blue);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--primary-blue);
        }

        /* Exit Button */
        .exit-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .exit-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--gray-300);
            border-radius: 12px;
            font-size: 16px;
            background: var(--white);
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 16px;
            border: 1px solid var(--gray-300);
            border-radius: 12px;
            font-size: 16px;
            background: var(--white);
            transition: border-color 0.2s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        /* Weight Scale Icon */
        .weight-icon {
            font-size: 24px;
            margin-bottom: 12px;
            text-align: center;
            display: block;
        }

        /* Athlete List */
        .athlete-card {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .athlete-card:hover {
            border-color: var(--primary-blue);
            box-shadow: 0 2px 8px rgba(26, 35, 126, 0.1);
        }

        .athlete-info {
            flex-grow: 1;
        }

        .athlete-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .athlete-status {
            font-size: 14px;
            color: var(--gray-500);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .status-success { background: var(--success-green); }
        .status-warning { background: var(--warning-orange); }
        .status-danger { background: var(--danger-red); }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            max-width: 100%;
            height: 70px;
            background: var(--white);
            border-top: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            color: var(--gray-500);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s ease;
            text-decoration: none;
            border-radius: 8px;
        }

        .nav-item.active {
            color: var(--primary-blue);
            background: rgba(26, 35, 126, 0.1);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* Chart Container */
        .chart-container {
            height: 200px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            font-weight: 500;
            margin-bottom: 20px;
        }

        /* Assessment Form */
        .assessment-question {
            margin-bottom: 24px;
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--gray-900);
        }

        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .answer-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .answer-option:hover {
            border-color: var(--primary-blue);
            background: rgba(26, 35, 126, 0.02);
        }

        .answer-option input[type="radio"] {
            margin-left: 12px;
        }

        .answer-option input[type="checkbox"] {
            margin-left: 12px;
        }

        /* Custom styling for assessment form elements */
        .assessment-question .form-input {
            border: 2px solid var(--gray-300);
            transition: border-color 0.2s ease;
        }

        .assessment-question .form-input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .assessment-question textarea.form-input {
            font-family: var(--font-family);
            line-height: 1.4;
        }

        /* Assessment Progress */
        .assessment-progress {
            margin-bottom: 20px;
        }

        .assessment-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .assessment-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-teal) 100%);
            transition: width 0.3s ease;
        }

        /* Chat Messages */
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
        }

        .message.sent {
            background: var(--primary-blue);
            color: var(--white);
            margin-right: auto;
            margin-left: 20%;
        }

        .message.received {
            background: var(--gray-100);
            color: var(--gray-900);
            margin-left: auto;
            margin-right: 20%;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }
            
            .bottom-nav {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Welcome Screen -->
        <div id="welcome" class="screen">
            <div class="welcome-content">
                <div class="app-logo">🥋</div>
                <h1 class="welcome-title">JudoNutrition</h1>
                <p class="welcome-subtitle">מערכת ליווי תזונתי מקצועית לספורטאי ג'ודו</p>
                
                <div class="role-selection">
                    <button class="role-btn" data-role="athlete">
                        <span>🥋</span>
                        <span>אני ספורטאי/ת</span>
                    </button>
                    <button class="role-btn" data-role="nutritionist">
                        <span>👩‍⚕️</span>
                        <span>אני תזונאי/ת</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Athlete Home Screen -->
        <div id="athleteHome" class="screen hidden">
            <div class="screen-header">
                <button class="exit-btn" onclick="exitToWelcome()">🔄 החלפת תפקיד</button>
                <div class="screen-title">שלום, דני! 🥋</div>
                <div class="screen-subtitle">התחרות הבאה בעוד <span id="daysToCompetition">12</span> ימים</div>
            </div>
            
            <!-- Dynamic Alert for Weight Status -->
            <div id="weightStatusAlert"></div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="currentWeight">72.5</div>
                    <div class="metric-label">משקל נוכחי</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="targetWeight">73.0</div>
                    <div class="metric-label">יעד קטגוריה</div>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-header">
                    <span class="progress-label">התקדמות ליעד</span>
                    <span class="progress-value" id="progressValue">92%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 92%;"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">המשימות שלי היום</div>
                <div id="dailyTasks">
                    <div class="task-item">
                        <span class="task-status">✅</span>
                        <span class="task-name">שקילה יומית</span>
                    </div>
                    <div class="task-item">
                        <span class="task-status">⏳</span>
                        <span class="task-name">שתיית מים - 1.8/2.5 ליטר</span>
                    </div>
                    <div class="task-item">
                        <span class="task-status">📋</span>
                        <span class="task-name">הערכה שבועית</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary nav-btn" data-screen="chat">
                💬 תקשורת עם התזונאי/ת
            </button>
            <button class="btn btn-secondary nav-btn" data-screen="weightTracking">
                ⚖️ הזנת משקל
            </button>
        </div>

        <!-- Weight Tracking Screen -->
        <div id="weightTracking" class="screen hidden">
            <div class="screen-header">
                <button class="exit-btn" onclick="exitToWelcome()">🔄 החלפת תפקיד</button>
                <div class="screen-title">🧍‍♂️ מעקב משקל</div>
                <div class="screen-subtitle">קטגוריה: עד 73 ק"ג</div>
            </div>
            
            <div class="chart-container">
                גרף התקדמות - 14 ימים אחרונים
            </div>
            
            <form id="weightForm">
                <div class="form-group">
                    <label class="form-label">🧍‍♂️ משקל נוכחי (ק"ג)</label>
                    <input type="number" id="weightInput" class="form-input" placeholder="72.5" step="0.1" min="40" max="150" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">זמן שקילה</label>
                    <select id="weightTiming" class="form-select">
                        <option value="לפני ארוחת בוקר">לפני ארוחת בוקר</option>
                        <option value="אחרי ארוחת בוקר">אחרי ארוחת בוקר</option>
                        <option value="צהריים">צהריים</option>
                        <option value="ערב">ערב</option>
                        <option value="מלל חופשי">מלל חופשי</option>
                    </select>
                </div>
                
                <div class="form-group" id="freeTextGroup" style="display: none;">
                    <label class="form-label">הערות נוספות</label>
                    <input type="text" id="weightNotes" class="form-input" placeholder="הקלד הערה...">
                </div>
                
                <button type="submit" class="btn btn-primary">💾 שמור משקל</button>
            </form>
            
            <button class="btn btn-secondary nav-btn" data-screen="athleteHome">
                🏠 חזרה לדף הבית
            </button>
        </div>

        <!-- Weekly Assessment Screen -->
        <div id="weeklyAssessment" class="screen hidden">
            <div class="screen-header">
                <button class="exit-btn" onclick="exitToWelcome()">🔄 החלפת תפקיד</button>
                <div class="screen-title">הערכה שבועית מורחבת</div>
                <div class="screen-subtitle">שאלה 1 מתוך 14</div>
            </div>
            
                            <div class="assessment-progress">
                <div class="assessment-progress-bar">
                    <div class="assessment-progress-fill" id="assessmentProgress" style="width: 7.14%;"></div>
                </div>
            </div>
            
            <div id="assessmentContainer">
                <!-- השאלות יוכנסו כאן דינמית -->
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" id="prevQuestion" style="flex: 1;" disabled>הקודמת</button>
                <button class="btn btn-primary" id="nextQuestion" style="flex: 1;">הבאה</button>
            </div>
        </div>

        <!-- Nutritionist Dashboard -->
        <div id="nutritionistDashboard" class="screen hidden">
            <div class="screen-header">
                <button class="exit-btn" onclick="exitToWelcome()">🔄 החלפת תפקיד</button>
                <div class="screen-title">מרכז בקרה</div>
                <div class="screen-subtitle">ד"ר שרה כהן • תזונאית מוסמכת</div>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="activeAthletes">12</div>
                    <div class="metric-label">ספורטאים פעילים</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="alertsCount">3</div>
                    <div class="metric-label">התראות</div>
                </div>
            </div>
            
            <div id="alertsContainer">
                <div class="alert alert-danger">
                    <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    <span><strong>דחוף:</strong> מיכאל - ירידה חריגה במשקל (2.1 ק"ג בשבוע)</span>
                </div>
                
                <div class="alert alert-warning">
                    <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>שרה לא מילאה הערכה שבועית (3 ימים)</span>
                </div>
            </div>
            
            <!-- נתונים סטטיסטיים נוספים -->
            <div id="nutritionistStats"></div>
            
            <button class="btn btn-primary nav-btn" data-screen="athletesList">
                📋 רשימת ספורטאים
            </button>
            <button class="btn btn-secondary nav-btn" data-screen="nutritionistReports">
                📊 דוחות מפורטים
            </button>
            <button class="btn btn-secondary nav-btn" data-screen="nutritionistChat">
                💬 צ'אט עם ספורטאים
            </button>
        </div>

        <!-- Athletes List -->
        <div id="athletesList" class="screen hidden">
            <div class="screen-header">
                <button class="exit-btn" onclick="exitToWelcome()">🔄 החלפת תפקיד</button>
                <div class="screen-title">רשימת ספורטאים</div>
                <div class="screen-subtitle">12 ספורטאים פעילים</div>
            </div>
            
            <div class="athlete-card">
                <div class="athlete-info">
                    <div class="athlete-name">דני כהן</div>
                    <div class="athlete-status">72.5 ק"ג • קטגוריה 73 • תחרות בעוד 12 ימים</div>
                </div>
                <div class="status-indicator status-success"></div>
            </div>
            
            <div class="athlete-card">
                <div class="athlete-info">
                    <div class="athlete-name">שרה לוי</div>
                    <div class="athlete-status">58.2 ק"ג • קטגוריה 57 • הערכה ממתינה</div>
                </div>
                <div class="status-indicator status-warning"></div>
            </div>
            
            <div class="athlete-card">
                <div class="athlete-info">
                    <div class="athlete-name">מיכאל אברהם</div>
                    <div class="athlete-status">83.1 ק"ג • קטגוריה 81 • ירידה חריגה</div>
                </div>
                <div class="status-indicator status-danger"></div>
            </div>
            
            <button class="btn btn-secondary nav-btn" data-screen="nutritionistDashboard">
                🏠 חזרה לדשבורד
            </button>
        </div>

        <!-- Nutritionist Reports -->
        <div id="nutritionistReports" class="screen hidden">
            <div class="screen-header">
                <button class="exit-btn" onclick="exitToWelcome()">🔄 החלפת תפקיד</button>
                <div class="screen-title">דוחות מפורטים</div>
                <div class="screen-subtitle">ניתוח נתונים ומגמות</div>
            </div>
            
            <div class="card">
                <div class="card-header">דוח שבועי</div>
                <p>• 11/12 ספורטאים שקלו השבוע</p>
                <p>• 9/12 מילאו הערכה שבועית</p>
                <p>• ממוצע ירידת משקל: 0.8 ק"ג לשבוע</p>
                <p>• 3 התראות פעילות</p>
            </div>
            
            <div class="card">
                <div class="card-header">מגמות חודשיות</div>
                <div class="chart-container">גרף מגמות משקל - חודש אחרון</div>
            </div>
            
            <button class="btn btn-primary">📄 ייצוא דוח PDF</button>
            <button class="btn btn-secondary nav-btn" data-screen="nutritionistDashboard">
                🏠 חזרה לדשבורד
            </button>
        </div>

        <!-- Nutritionist Chat -->
        <div id="nutritionistChat" class="screen hidden">
            <div class="screen-header">
                <button class="exit-btn" onclick="exitToWelcome()">🔄 החלפת תפקיד</button>
                <div class="screen-title">צ'אט עם ספורטאים</div>
                <div class="screen-subtitle">תקשורת ישירה</div>
            </div>
            
            <div class="card">
                <div class="card-header">דני כהן</div>
                <div class="chat-messages">
                    <div class="message received">
                        <div>שלום! יש לי שאלה לגבי התזונה לפני התחרות</div>
                        <div class="message-time">היום 14:30</div>
                    </div>
                    <div class="message sent">
                        <div>שלום דני! בטח, מה השאלה?</div>
                        <div class="message-time">היום 14:35</div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="nutritionistChatInput" class="form-input" placeholder="הקלד הודעה..." style="margin: 0;">
                    <button class="btn btn-primary" id="nutritionistSendBtn" style="width: auto; margin: 0; padding: 16px;">שלח</button>
                </div>
            </div>
            
            <button class="btn btn-secondary nav-btn" data-screen="nutritionistDashboard">
                🏠 חזרה לדשבורד
            </button>
        </div>

        <!-- Chat Screen (for Athletes) -->
        <div id="chat" class="screen hidden">
            <div class="screen-header">
                <button class="exit-btn" onclick="exitToWelcome()">🔄 החלפת תפקיד</button>
                <div class="screen-title">תקשורת</div>
                <div class="screen-subtitle">עם התזונאי/ת</div>
            </div>
            
            <div class="card">
                <div class="card-header">צ'אט עם ד"ר שרה כהן</div>
                <div class="chat-messages">
                    <div class="message received">
                        <div>שלום דני! איך אתה מרגיש השבוע?</div>
                        <div class="message-time">אתמול 16:20</div>
                    </div>
                    <div class="message sent">
                        <div>שלום! טוב בסך הכל, קצת עייפות אחרי האימונים</div>
                        <div class="message-time">אתמול 18:45</div>
                    </div>
                    <div class="message received">
                        <div>זה נורמלי לקראת תחרות. תמשיך עם התוכנית</div>
                        <div class="message-time">היום 09:15</div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="athleteChatInput" class="form-input" placeholder="הקלד הודעה..." style="margin: 0;">
                    <button class="btn btn-primary" id="athleteSendBtn" style="width: auto; margin: 0; padding: 16px;">שלח</button>
                </div>
            </div>
            
            <button class="btn btn-secondary nav-btn" data-screen="athleteHome">
                🏠 חזרה לדף הבית
            </button>
        </div>

        <!-- Bottom Navigation for Athletes -->
        <div id="athleteBottomNav" class="bottom-nav hidden">
            <a href="#" class="nav-item nav-btn active" data-screen="athleteHome">
                <div class="nav-icon">🏠</div>
                <div>בית</div>
            </a>
            <a href="#" class="nav-item nav-btn" data-screen="weightTracking">
                <div class="nav-icon">🧍‍♂️</div>
                <div>משקל</div>
            </a>
            <a href="#" class="nav-item nav-btn" data-screen="weeklyAssessment">
                <div class="nav-icon">📋</div>
                <div>הערכה</div>
            </a>
            <a href="#" class="nav-item nav-btn" data-screen="chat">
                <div class="nav-icon">💬</div>
                <div>תקשורת</div>
            </a>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 🥋 JudoNutrition App - גרסה משופרת
        // גרסה: MVP 1.2 עם שיפורים מלאים

        // ========== משתנים גלובליים ==========
        let currentUser = {
            role: null,
            name: '',
            data: {}
        };

        let appData = {
            athletes: {},
            nutritionist: {},
            currentScreen: 'welcome'
        };

        // שאלון הערכה שבועית מורחב (12 שאלות)
        const weeklyQuestions = [
            {
                id: 1,
                text: "כמה שעות ישנת בממוצע בלילה השבוע?",
                options: [
                    { value: 5, text: "8+ שעות - השינה הייתה מעולה" },
                    { value: 4, text: "7-8 שעות - שינה טובה" },
                    { value: 3, text: "6-7 שעות - שינה סבירה" },
                    { value: 2, text: "5-6 שעות - שינה לא מספקת" },
                    { value: 1, text: "פחות מ-5 שעות - שינה גרועה" }
                ]
            },
            {
                id: 2,
                text: "איך התיאבון שלך השבוע?",
                options: [
                    { value: 5, text: "מעולה - תיאבון טוב ונהנה מהאוכל" },
                    { value: 4, text: "טוב - תיאבון רגיל" },
                    { value: 3, text: "סביר - לפעמים פחות תיאבון" },
                    { value: 2, text: "לא טוב - תיאבון ירד משמעותי" },
                    { value: 1, text: "גרוע - כמעט אין תיאבון" }
                ]
            },
            {
                id: 3,
                text: "איך הרגשת באימונים השבוע?",
                options: [
                    { value: 5, text: "מעולה - מלא אנרגיה וכוח" },
                    { value: 4, text: "טוב - הרגשתי חזק" },
                    { value: 3, text: "סביר - קצת עייפות" },
                    { value: 2, text: "קשה - הרבה עייפות" },
                    { value: 1, text: "מאוד קשה - כמעט לא יכולתי" }
                ]
            },
            {
                id: 4,
                text: "כמה ליטר מים שתית בממוצע ביום השבוע?",
                options: [
                    { value: 5, text: "3+ ליטר ביום" },
                    { value: 4, text: "2.5-3 ליטר ביום" },
                    { value: 3, text: "2-2.5 ליטר ביום" },
                    { value: 2, text: "1.5-2 ליטר ביום" },
                    { value: 1, text: "פחות מ-1.5 ליטר ביום" }
                ]
            },
            {
                id: 5,
                text: "איך היה הרעב שלך השבוע?",
                options: [
                    { value: 5, text: "מאוזן - רעב רגיל בזמנים הנכונים" },
                    { value: 4, text: "טוב - רעב קל לפני הארוחות" },
                    { value: 3, text: "סביר - לפעמים רעב חזק" },
                    { value: 2, text: "בעייתי - רעב חזק מדי או חוסר רעב" },
                    { value: 1, text: "קיצוני - רעב חזק מאוד או אובדן רעב" }
                ]
            },
            {
                id: 6,
                text: "איך הרגשת מבחינה נפשית/מנטלית השבוע?",
                options: [
                    { value: 5, text: "מעולה - מוטיבציה גבוהה ומצב רוח חיובי" },
                    { value: 4, text: "טוב - במצב רוח טוב ומאוזן" },
                    { value: 3, text: "סביר - מצב רוח ממוצע" },
                    { value: 2, text: "לא טוב - עצבנות או דיכאון קל" },
                    { value: 1, text: "גרוע - דיכאון, חרדה או מצב רוח נמוך" }
                ]
            },
            {
                id: 7,
                text: "יש פציעות, כאבים או אי נוחות השבוע?",
                options: [
                    { value: 5, text: "לא - הכל תקין ללא כאבים" },
                    { value: 4, text: "כאבי שרירים קלים לאחר אימון" },
                    { value: 3, text: "כאב קל באזור ספציפי" },
                    { value: 2, text: "כאב בינוני שמפריע קצת לפעילות" },
                    { value: 1, text: "כאב חזק או פציעה המפריעים לאימון" }
                ]
            },
            {
                id: 8,
                text: "מה המחזור החודשי שלך? (נשים בלבד)",
                options: [
                    { value: 5, text: "סדיר וללא בעיות" },
                    { value: 4, text: "סדיר עם תסמינים קלים" },
                    { value: 3, text: "קצת לא סדיר או תסמינים בינוניים" },
                    { value: 2, text: "לא סדיר או תסמינים קשים" },
                    { value: 1, text: "אין מחזור / בעיות משמעותיות" }
                ]
            },
            {
                id: 9,
                text: "אילו תוספי תזונה נטלת השבוע?",
                options: [
                    { value: 5, text: "רק את מה שהומלץ לי" },
                    { value: 4, text: "ויטמינים בסיסיים + המלצות" },
                    { value: 3, text: "תוספים נוספים מעבר להמלצות" },
                    { value: 2, text: "שכחתי לקחת חלק מהתוספים" },
                    { value: 1, text: "לא לקחתי תוספים כלל השבוע" }
                ]
            },
            {
                id: 10,
                text: "האם היו לך חריגות תזונתיות השבוע?",
                options: [
                    { value: 5, text: "לא - עקבתי אחר התוכנית במדויק" },
                    { value: 4, text: "חריגה קלה - אירוע אחד בלבד" },
                    { value: 3, text: "כמה חריגות קטנות" },
                    { value: 2, text: "חריגות משמעותיות - יום שלם" },
                    { value: 1, text: "חריגות גדולות - מספר ימים" }
                ]
            },
            {
                id: 11,
                text: "איך האנרגיה שלך במהלך היום השבוע?",
                options: [
                    { value: 5, text: "מעולה - אנרגיה יציבה כל היום" },
                    { value: 4, text: "טוב - אנרגיה טובה עם ירידה קלה אחה״צ" },
                    { value: 3, text: "סביר - עליות וירידות באנרגיה" },
                    { value: 2, text: "לא טוב - עייפות בחלקים גדולים של היום" },
                    { value: 1, text: "גרוע - עייפות קיצונית רוב היום" }
                ]
            },
            {
                id: 12,
                text: "בסך הכל, איך אתה מרגיש השבוע ביחס לשבוע שעבר?",
                options: [
                    { value: 5, text: "הרבה יותר טוב - שיפור משמעותי" },
                    { value: 4, text: "יותר טוב - שיפור קל" },
                    { value: 3, text: "אותו דבר - ללא שינוי" },
                    { value: 2, text: "יותר גרוע - הרגשה פחות טובה" },
                    { value: 1, text: "הרבה יותר גרוע - הידרדרות משמעותי" }
                ]
            }
        ];

        let currentAssessment = {
            currentQuestion: 0,
            answers: {},
            isCompleted: false
        };

        // ========== פונקציות ניהול מסכים ==========

        function showScreen(screenId) {
            console.log('Attempting to show screen:', screenId);
            
            // הסתרת כל המסכים
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // הצגת המסך הנבחר
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                appData.currentScreen = screenId;
                
                // ניהול ניווטיציה תחתונה
                manageBottomNav(screenId);
                
                // עדכון נתונים במסך
                updateScreenData(screenId);
                
                console.log('Successfully switched to screen:', screenId);
            } else {
                console.error('Screen not found:', screenId);
            }
        }

        function manageBottomNav(screenId) {
            const bottomNav = document.getElementById('athleteBottomNav');
            
            if (currentUser.role === 'athlete') {
                const athleteScreens = ['athleteHome', 'weightTracking', 'weeklyAssessment', 'chat'];
                if (athleteScreens.includes(screenId)) {
                    bottomNav.classList.remove('hidden');
                    
                    // עדכון פריט פעיל
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    const activeItem = document.querySelector(`[data-screen="${screenId}"]`);
                    if (activeItem && activeItem.classList.contains('nav-item')) {
                        activeItem.classList.add('active');
                    }
                } else {
                    bottomNav.classList.add('hidden');
                }
            } else {
                bottomNav.classList.add('hidden');
            }
        }

        function selectRole(role) {
            console.log('Role selected:', role);
            
            currentUser.role = role;
            localStorage.setItem('userRole', role);
            
            if (role === 'athlete') {
                currentUser.name = "דני כהן";
                initializeAthleteData();
                showScreen('athleteHome');
            } else if (role === 'nutritionist') {
                currentUser.name = "ד״ר שרה כהן";
                initializeNutritionistData();
                showScreen('nutritionistDashboard');
            }
            
            console.log('User role set successfully:', role);
        }

        function exitToWelcome() {
            console.log('Exiting to welcome screen');
            
            // מחיקת התפקיד השמור
            localStorage.removeItem('userRole');
            currentUser.role = null;
            
            // מעבר למסך בחירה
            showScreen('welcome');
        }

        function updateScreenData(screenId) {
            switch(screenId) {
                case 'athleteHome':
                    updateAthleteHome();
                    break;
                case 'nutritionistDashboard':
                    updateNutritionistDashboard();
                    break;
                case 'weightTracking':
                    updateWeightChart();
                    break;
                case 'chat':
                    updateChatDisplay('chat');
                    break;
                case 'nutritionistChat':
                    updateChatDisplay('nutritionistChat');
                    break;
            }
        }

        // ========== נתונים לדוגמה ==========

        function initializeAthleteData() {
            console.log('Initializing athlete data');
            
            if (!appData.athletes[currentUser.name]) {
                appData.athletes[currentUser.name] = {
                    profile: {
                        name: "דני כהן",
                        category: "73kg",
                        targetWeight: 73.0,
                        nextCompetition: "2024-02-15"
                    },
                    weights: [
                        { date: "2024-01-15", weight: 74.2, timing: "לפני ארוחת בוקר" },
                        { date: "2024-01-16", weight: 73.8, timing: "לפני ארוחת בוקר" },
                        { date: "2024-01-17", weight: 73.5, timing: "לפני ארוחת בוקר" },
                        { date: "2024-01-18", weight: 73.2, timing: "לפני ארוחת בוקר" },
                        { date: "2024-01-19", weight: 72.8, timing: "לפני ארוחת בוקר" },
                        { date: "2024-01-20", weight: 72.5, timing: "לפני ארוחת בוקר" }
                    ],
                    assessments: [
                        {
                            date: "2024-01-15",
                            answers: { 1: 4, 2: 5, 3: 4, 4: 4, 5: 5 }
                        }
                    ],
                    tasks: [
                        { id: 1, name: "שקילה יומית", completed: true, type: "daily" },
                        { id: 2, name: "שתיית 2.5 ליטר מים", completed: false, type: "daily", progress: 1.8 },
                        { id: 3, name: "הערכה שבועית", completed: false, type: "weekly" }
                    ]
                };
            }
            
            saveData('athleteData', appData.athletes);
        }

        function initializeNutritionistData() {
            console.log('Initializing nutritionist data');
            
            if (!appData.nutritionist.athletes) {
                appData.nutritionist = {
                    profile: {
                        name: "ד״ר שרה כהן",
                        title: "תזונאית מוסמכת"
                    },
                    athletes: [
                        {
                            id: "danny123",
                            name: "דני כהן",
                            currentWeight: 72.5,
                            targetWeight: 73.0,
                            category: "73kg",
                            lastUpdate: "2024-01-20",
                            status: "success",
                            nextCompetition: "2024-02-15",
                            daysToCompetition: 12
                        },
                        {
                            id: "sarah456",
                            name: "שרה לוי",
                            currentWeight: 58.2,
                            targetWeight: 57.0,
                            category: "57kg",
                            lastUpdate: "2024-01-17",
                            status: "warning",
                            nextCompetition: "2024-02-20",
                            daysToCompetition: 20
                        },
                        {
                            id: "michael789",
                            name: "מיכאל אברהם",
                            currentWeight: 83.1,
                            targetWeight: 81.0,
                            category: "81kg",
                            lastUpdate: "2024-01-20",
                            status: "danger",
                            nextCompetition: "2024-02-10",
                            daysToCompetition: 8
                        }
                    ],
                    alerts: [
                        {
                            athleteId: "michael789",
                            type: "weight_above_target",
                            message: "מיכאל - ירידה חריגה במשקל (2.1 ק״ג בשבוע)",
                            severity: "high",
                            date: "2024-01-20"
                        },
                        {
                            athleteId: "sarah456", 
                            type: "assessment_missing",
                            message: "שרה - לא מילאה הערכה שבועית (3 ימים)",
                            severity: "medium",
                            date: "2024-01-18"
                        }
                    ]
                };
            }
            
            saveData('nutritionistData', appData.nutritionist);
        }

        // ========== פונקציות צ'אט ==========

        function initializeChat() {
            // אתחול מערכת צ'אט
            if (!appData.chat) {
                appData.chat = {
                    conversations: [
                        {
                            id: 1,
                            participants: ["דני כהן", "ד״ר שרה כהן"],
                            messages: [
                                {
                                    id: 1,
                                    sender: "ד״ר שרה כהן",
                                    message: "שלום דני! איך אתה מרגיש השבוע?",
                                    timestamp: "2024-01-19T16:20:00",
                                    read: true
                                },
                                {
                                    id: 2,
                                    sender: "דני כהן",
                                    message: "שלום! טוב בסך הכל, קצת עייפות אחרי האימונים",
                                    timestamp: "2024-01-19T18:45:00",
                                    read: true
                                },
                                {
                                    id: 3,
                                    sender: "ד״ר שרה כהן",
                                    message: "זה נורמלי לקראת תחרות. תמשיך עם התוכנית",
                                    timestamp: "2024-01-20T09:15:00",
                                    read: true
                                }
                            ]
                        }
                    ]
                };
                saveData('chatData', appData.chat);
            }
        }

        function loadChatMessages() {
            const savedChat = loadData('chatData');
            if (savedChat) {
                appData.chat = savedChat;
            } else {
                initializeChat();
            }
        }

        function updateChatDisplay(screenId) {
            loadChatMessages();
            
            const conversation = appData.chat.conversations[0]; // קשר ראשון לדוגמה
            const messagesContainer = document.querySelector(`#${screenId} .chat-messages`);
            
            if (!messagesContainer || !conversation) return;
            
            const currentUserName = currentUser.name;
            
            messagesContainer.innerHTML = '';
            
            conversation.messages.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${msg.sender === currentUserName ? 'sent' : 'received'}`;
                
                const time = new Date(msg.timestamp).toLocaleString('he-IL', {
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageEl.innerHTML = `
                    <div>${msg.message}</div>
                    <div class="message-time">${time}</div>
                `;
                
                messagesContainer.appendChild(messageEl);
            });
            
            // גלילה למטה
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage(message, screenId) {
            if (!message.trim()) return;
            
            loadChatMessages();
            const conversation = appData.chat.conversations[0];
            
            const newMessage = {
                id: conversation.messages.length + 1,
                sender: currentUser.name,
                message: message.trim(),
                timestamp: new Date().toISOString(),
                read: false
            };
            
            conversation.messages.push(newMessage);
            saveData('chatData', appData.chat);
            
            // עדכון התצוגה
            updateChatDisplay(screenId);
            
            // סימולציה של תגובה אוטומטית אחרי 2 שניות
            setTimeout(() => {
                simulateResponse(screenId);
            }, 2000);
        }

        function simulateResponse(screenId) {
            const responses = [
                "תודה על העדכון! ממשיך לעקוב אחריך",
                "נשמע טוב! תמיד אפשר ליצור קשר אם יש שאלות",
                "המשך כך! האתה במסלול הנכון",
                "אשמח לשמוע עוד פרטים בהמשך השבוע",
                "זה חשוב לי לדעת איך אתה מרגיש. תודה!"
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            const otherUser = currentUser.role === 'athlete' ? 'ד״ר שרה כהן' : 'דני כהן';
            
            loadChatMessages();
            const conversation = appData.chat.conversations[0];
            
            const responseMessage = {
                id: conversation.messages.length + 1,
                sender: otherUser,
                message: randomResponse,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            conversation.messages.push(responseMessage);
            saveData('chatData', appData.chat);
            
            updateChatDisplay(screenId);
        }

        function updateAthleteHome() {
            const athleteData = appData.athletes[currentUser.name];
            if (!athleteData) return;
            
            // עדכון משקל נוכחי
            const currentWeightEl = document.getElementById('currentWeight');
            if (currentWeightEl && athleteData.weights.length > 0) {
                const latestWeight = athleteData.weights[athleteData.weights.length - 1];
                currentWeightEl.textContent = latestWeight.weight;
            }
            
            // עדכון יעד קטגוריה
            const targetWeightEl = document.getElementById('targetWeight');
            if (targetWeightEl) {
                targetWeightEl.textContent = athleteData.profile.targetWeight;
            }
            
            // עדכון ימים לתחרות
            const competitionEl = document.getElementById('daysToCompetition');
            if (competitionEl) {
                const daysLeft = calculateDaysToCompetition(athleteData.profile.nextCompetition);
                competitionEl.textContent = daysLeft;
            }
            
            // עדכון משימות יומיות
            updateDailyTasks(athleteData.tasks);
            
            // עדכון התקדמות
            updateProgress(athleteData);
            
            // עדכון התראת סטטוס משקל
            updateWeightStatusAlert(athleteData);
        }

        function updateWeightStatusAlert(athleteData) {
            const alertContainer = document.getElementById('weightStatusAlert');
            if (!alertContainer || !athleteData.weights.length) return;
            
            const currentWeight = athleteData.weights[athleteData.weights.length - 1].weight;
            const targetWeight = athleteData.profile.targetWeight;
            const percentageDiff = ((currentWeight - targetWeight) / targetWeight) * 100;
            
            alertContainer.innerHTML = '';
            
            if (Math.abs(percentageDiff) > 2) { // חריגה של יותר מ-2%
                const alertType = percentageDiff > 0 ? 'danger' : 'warning';
                const message = percentageDiff > 0 
                    ? `⚠️ המשקל גבוה מהיעד ב-${Math.abs(percentageDiff).toFixed(1)}% - צריך להוריד ${(currentWeight - targetWeight).toFixed(1)} ק"ג`
                    : `📉 המשקל נמוך מהיעד ב-${Math.abs(percentageDiff).toFixed(1)}% - זהירות מירידה מהירה מדי`;
                
                alertContainer.innerHTML = `
                    <div class="alert alert-${alertType}">
                        <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>
                        <span>${message}</span>
                    </div>
                `;
            } else if (Math.abs(percentageDiff) <= 1) { // במסלול
                alertContainer.innerHTML = `
                    <div class="alert alert-success">
                        <svg class="alert-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span>✅ המשקל במסלול המתוכנן (${Math.abs(percentageDiff).toFixed(1)}% מהיעד). המשך בתוכנית הנוכחית.</span>
                    </div>
                `;
            }
        }

        function updateNutritionistDashboard() {
            const nutritionistData = appData.nutritionist;
            if (!nutritionistData) return;
            
            // עדכון מספר ספורטאים פעילים
            const activeAthletesEl = document.getElementById('activeAthletes');
            if (activeAthletesEl) {
                activeAthletesEl.textContent = nutritionistData.athletes.length;
            }
            
            // עדכון מספר התראות
            const alertsCountEl = document.getElementById('alertsCount');
            if (alertsCountEl) {
                alertsCountEl.textContent = nutritionistData.alerts.length;
            }
            
            // הוספת נתונים סטטיסטיים נוספים
            const statsContainer = document.getElementById('nutritionistStats');
            if (statsContainer) {
                // חישוב ממוצע ירידת משקל
                const weightLossAvg = calculateAverageWeightLoss(nutritionistData.athletes);
                
                statsContainer.innerHTML = `
                    <div class="card">
                        <div class="card-header">סטטיסטיקות שבועיות</div>
                        <p><strong>ממוצע ירידת משקל:</strong> ${weightLossAvg} ק"ג לשבוע</p>
                        <p><strong>ספורטאים שהגיעו ליעד:</strong> ${countAthletesAtTarget(nutritionistData.athletes)}</p>
                        <p><strong>שיעור השלמת הערכות:</strong> ${calculateAssessmentRate()}%</p>
                        <p><strong>תחרויות השבוע:</strong> ${countUpcomingCompetitions(nutritionistData.athletes)}</p>
                    </div>
                `;
            }
        }

        function calculateAverageWeightLoss(athletes) {
            // סימולציה של חישוב ממוצע ירידת משקל
            let totalLoss = 0;
            let count = 0;
            
            athletes.forEach(athlete => {
                if (athlete.currentWeight < 75) { // רק ספורטאים שירדו במשקל
                    totalLoss += (75 - athlete.currentWeight); // הנחה שהמשקל ההתחלתי היה 75
                    count++;
                }
            });
            
            return count > 0 ? (totalLoss / count).toFixed(1) : '0.0';
        }

        function countAthletesAtTarget(athletes) {
            return athletes.filter(athlete => 
                Math.abs(athlete.currentWeight - athlete.targetWeight) <= 0.5
            ).length;
        }

        function calculateAssessmentRate() {
            // סימולציה של שיעור השלמת הערכות
            return 85; // אחוז קבוע לדוגמה
        }

        function countUpcomingCompetitions(athletes) {
            return athletes.filter(athlete => athlete.daysToCompetition <= 7).length;
        }

        function updateDailyTasks(tasks) {
            const tasksContainer = document.getElementById('dailyTasks');
            if (!tasksContainer || !tasks) return;
            
            tasksContainer.innerHTML = '';
            
            tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-item';
                
                const statusIcon = task.completed ? '✅' : 
                                  task.progress ? '⏳' : '📋';
                
                const progressText = task.progress ? 
                    ` - ${task.progress}/${task.progress + 0.7} ליטר` : '';
                
                taskEl.innerHTML = `
                    <span class="task-status">${statusIcon}</span>
                    <span class="task-name">${task.name}${progressText}</span>
                `;
                
                tasksContainer.appendChild(taskEl);
            });
        }

        function updateProgress(athleteData) {
            const progressEl = document.getElementById('progressFill');
            const progressValueEl = document.getElementById('progressValue');
            
            if (!progressEl || !progressValueEl || !athleteData.weights.length) return;
            
            const currentWeight = athleteData.weights[athleteData.weights.length - 1].weight;
            const targetWeight = athleteData.profile.targetWeight;
            const startWeight = athleteData.weights[0].weight;
            
            // חישוב מדויק יותר של התקדמות
            if (currentWeight <= targetWeight) {
                // הגיע ליעד או מתחתיו
                progressEl.style.width = '100%';
                progressValueEl.textContent = '100%';
                progressEl.style.background = 'linear-gradient(90deg, var(--success-green) 0%, var(--primary-teal) 100%)';
            } else if (currentWeight >= startWeight) {
                // עדיין במשקל ההתחלה או למעלה ממנו
                progressEl.style.width = '0%';
                progressValueEl.textContent = '0%';
                progressEl.style.background = 'linear-gradient(90deg, var(--danger-red) 0%, var(--warning-orange) 100%)';
            } else {
                // בתהליך
                const progress = ((startWeight - currentWeight) / (startWeight - targetWeight)) * 100;
                const progressPercent = Math.min(100, Math.max(0, progress));
                
                progressEl.style.width = progressPercent + '%';
                progressValueEl.textContent = Math.round(progressPercent) + '%';
                
                // שינוי צבע לפי התקדמות
                if (progressPercent >= 80) {
                    progressEl.style.background = 'linear-gradient(90deg, var(--success-green) 0%, var(--primary-teal) 100%)';
                } else if (progressPercent >= 50) {
                    progressEl.style.background = 'linear-gradient(90deg, var(--warning-orange) 0%, var(--primary-teal) 100%)';
                } else {
                    progressEl.style.background = 'linear-gradient(90deg, var(--danger-red) 0%, var(--warning-orange) 100%)';
                }
            }
        }

        // ========== שאלון הערכה שבועית ==========

        function loadWeeklyAssessment() {
            const container = document.getElementById('assessmentContainer');
            if (!container) return;
            
            // וידוא שהכפתורים גלויים
            const prevBtn = document.getElementById('prevQuestion');
            const nextBtn = document.getElementById('nextQuestion');
            if (prevBtn) prevBtn.style.display = 'flex';
            if (nextBtn) nextBtn.style.display = 'flex';
            
            // איפוס הערכה
            if (currentAssessment.currentQuestion === 0 && Object.keys(currentAssessment.answers).length === 0) {
                currentAssessment.currentQuestion = 0;
                currentAssessment.answers = {};
                currentAssessment.isCompleted = false;
            }
            
            displayCurrentQuestion();
            updateAssessmentProgress();
            updateAssessmentButtons();
        }

        function displayCurrentQuestion() {
            const container = document.getElementById('assessmentContainer');
            const currentQuestionEl = document.getElementById('currentQuestionNum');
            const totalQuestionsEl = document.getElementById('totalQuestions');
            
            if (!container) return;
            
            const questionIndex = currentAssessment.currentQuestion;
            const question = weeklyQuestions[questionIndex];
            
            if (!question) return;
            
            // עדכון מספרי שאלה
            if (currentQuestionEl) currentQuestionEl.textContent = questionIndex + 1;
            if (totalQuestionsEl) totalQuestionsEl.textContent = weeklyQuestions.length;
            
            let questionHtml = '';
            
            // בניית השאלה לפי סוג
            switch(question.type) {
                case 'weight':
                    questionHtml = `
                        <div class="assessment-question">
                            <div class="question-text">🧍‍♂️ ${question.text}</div>
                            <div class="form-group">
                                <input type="${question.inputType}" 
                                       id="question_${question.id}" 
                                       class="form-input" 
                                       placeholder="${question.placeholder}" 
                                       step="0.1" min="40" max="150"
                                       value="${currentAssessment.answers[question.id] || ''}"
                                       style="text-align: center; font-size: 18px; font-weight: 600;">
                                <div style="text-align: center; margin-top: 8px; color: #666; font-weight: 500;">${question.unit}</div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'time':
                    const bedtime = currentAssessment.answers[question.id]?.bedtime || '';
                    const waketime = currentAssessment.answers[question.id]?.waketime || '';
                    questionHtml = `
                        <div class="assessment-question">
                            <div class="question-text">🕐 ${question.text}</div>
                            <div class="form-group">
                                <label class="form-label">${question.fields[0].label}</label>
                                <input type="time" 
                                       id="bedtime_${question.id}" 
                                       class="form-input" 
                                       value="${bedtime}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">${question.fields[1].label}</label>
                                <input type="time" 
                                       id="waketime_${question.id}" 
                                       class="form-input" 
                                       value="${waketime}">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'input':
                    questionHtml = `
                        <div class="assessment-question">
                            <div class="question-text">💧 ${question.text}</div>
                            <div class="form-group">
                                <input type="${question.inputType}" 
                                       id="question_${question.id}" 
                                       class="form-input" 
                                       placeholder="${question.placeholder}" 
                                       step="${question.step || '1'}"
                                       value="${currentAssessment.answers[question.id] || ''}"
                                       style="text-align: center; font-size: 18px;">
                                <div style="text-align: center; margin-top: 8px; color: #666; font-weight: 500;">${question.unit}</div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'checkbox':
                    const selectedSupplements = currentAssessment.answers[question.id] || [];
                    const supplementsHtml = question.options.map(option => {
                        const isChecked = selectedSupplements.includes(option.value);
                        const inputHtml = option.hasInput ? `
                            <input type="text" 
                                   id="supplement_other_${option.value}" 
                                   class="form-input" 
                                   placeholder="${option.placeholder || 'פרט...'}" 
                                   style="margin-top: 8px; font-size: 14px;"
                                   value="${currentAssessment.answers[`${question.id}_${option.value}_text`] || ''}">
                        ` : '';
                        
                        return `
                            <label class="answer-option" style="flex-direction: column; align-items: flex-start;">
                                <div style="display: flex; align-items: center; width: 100%;">
                                    <input type="checkbox" 
                                           name="question_${question.id}" 
                                           value="${option.value}" 
                                           ${isChecked ? 'checked' : ''}
                                           style="margin-left: 12px;">
                                    <span>${option.text}</span>
                                </div>
                                ${inputHtml}
                            </label>
                        `;
                    }).join('');
                    
                    questionHtml = `
                        <div class="assessment-question">
                            <div class="question-text">💊 ${question.text}</div>
                            <div class="answer-options">
                                ${supplementsHtml}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'conditional':
                    const conditionValue = currentAssessment.answers[question.id] || '';
                    const followUpHtml = (question.followUp && conditionValue === question.followUp.trigger) ? `
                        <div class="form-group" style="margin-top: 16px;">
                            <label class="form-label">${question.followUp.question}</label>
                            <input type="text" 
                                   id="followup_${question.id}" 
                                   class="form-input" 
                                   placeholder="${question.followUp.placeholder}"
                                   value="${currentAssessment.answers[`${question.id}_followup`] || ''}">
                        </div>
                    ` : '';
                    
                    const optionsHtml = question.options.map(option => `
                        <label class="answer-option">
                            <input type="radio" 
                                   name="question_${question.id}" 
                                   value="${option.value}" 
                                   ${conditionValue === option.value ? 'checked' : ''}
                                   style="margin-left: 12px;">
                            <span>${option.text}</span>
                        </label>
                    `).join('');
                    
                    questionHtml = `
                        <div class="assessment-question">
                            <div class="question-text">🌸 ${question.text}</div>
                            <div class="answer-options">
                                ${optionsHtml}
                            </div>
                            ${followUpHtml}
                        </div>
                    `;
                    break;
                    
                case 'textarea':
                    const icon = question.id === 12 ? '🍽️' : '💭';
                    questionHtml = `
                        <div class="assessment-question">
                            <div class="question-text">${icon} ${question.text}</div>
                            <div class="form-group">
                                <textarea id="question_${question.id}" 
                                          class="form-input" 
                                          placeholder="${question.placeholder}" 
                                          rows="${question.rows}"
                                          style="min-height: ${question.rows * 24}px; resize: vertical;">${currentAssessment.answers[question.id] || ''}</textarea>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    // שאלות רגילות עם אפשרויות
                    const optionsHtml = question.options.map(option => `
                        <label class="answer-option">
                            <input type="radio" 
                                   name="question_${question.id}" 
                                   value="${option.value}" 
                                   ${currentAssessment.answers[question.id] === option.value ? 'checked' : ''}
                                   style="margin-left: 12px;">
                            <span>${option.text}</span>
                        </label>
                    `).join('');
                    
                    const questionIcon = getQuestionIcon(question.id);
                    questionHtml = `
                        <div class="assessment-question">
                            <div class="question-text">${questionIcon} ${question.text}</div>
                            <div class="answer-options">
                                ${optionsHtml}
                            </div>
                        </div>
                    `;
                    break;
            }
            
            container.innerHTML = questionHtml;
            
            // הוספת event listeners
            addQuestionEventListeners(question);
        }

        function getQuestionIcon(questionId) {
            const icons = {
                1: '😴', 2: '🌙', 3: '⏰', 4: '🍽️', 5: '💧', 
                6: '💊', 7: '🌸', 8: '🏥', 9: '😊', 10: '⚡', 11: '🔄'
            };
            return icons[questionId] || '📝';
        }

        function addQuestionEventListeners(question) {
            switch(question.type) {
                case 'weight':
                case 'input':
                    const input = document.getElementById(`question_${question.id}`);
                    if (input) {
                        input.addEventListener('input', function() {
                            currentAssessment.answers[question.id] = this.value;
                            updateAssessmentButtons();
                        });
                    }
                    break;
                    
                case 'time':
                    const bedtimeInput = document.getElementById(`bedtime_${question.id}`);
                    const waketimeInput = document.getElementById(`waketime_${question.id}`);
                    
                    [bedtimeInput, waketimeInput].forEach(input => {
                        if (input) {
                            input.addEventListener('change', function() {
                                if (!currentAssessment.answers[question.id]) {
                                    currentAssessment.answers[question.id] = {};
                                }
                                currentAssessment.answers[question.id][this.id.includes('bedtime') ? 'bedtime' : 'waketime'] = this.value;
                                updateAssessmentButtons();
                            });
                        }
                    });
                    break;
                    
                case 'checkbox':
                    const checkboxes = document.querySelectorAll(`input[name="question_${question.id}"]`);
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            if (!currentAssessment.answers[question.id]) {
                                currentAssessment.answers[question.id] = [];
                            }
                            
                            if (this.checked) {
                                if (!currentAssessment.answers[question.id].includes(this.value)) {
                                    currentAssessment.answers[question.id].push(this.value);
                                }
                            } else {
                                currentAssessment.answers[question.id] = currentAssessment.answers[question.id].filter(v => v !== this.value);
                            }
                            
                            updateAssessmentButtons();
                        });
                    });
                    
                    // Event listeners לשדות טקסט נוספים
                    question.options.forEach(option => {
                        if (option.hasInput) {
                            const textInput = document.getElementById(`supplement_other_${option.value}`);
                            if (textInput) {
                                textInput.addEventListener('input', function() {
                                    currentAssessment.answers[`${question.id}_${option.value}_text`] = this.value;
                                });
                            }
                        }
                    });
                    break;
                    
                case 'conditional':
                    const radioInputs = document.querySelectorAll(`input[name="question_${question.id}"]`);
                    radioInputs.forEach(radio => {
                        radio.addEventListener('change', function() {
                            currentAssessment.answers[question.id] = this.value;
                            updateAssessmentButtons();
                            
                            // רענון השאלה כדי להציג/להסתיר שאלת המשך
                            setTimeout(() => displayCurrentQuestion(), 100);
                        });
                    });
                    
                    const followUpInput = document.getElementById(`followup_${question.id}`);
                    if (followUpInput) {
                        followUpInput.addEventListener('input', function() {
                            currentAssessment.answers[`${question.id}_followup`] = this.value;
                        });
                    }
                    break;
                    
                case 'textarea':
                    const textarea = document.getElementById(`question_${question.id}`);
                    if (textarea) {
                        textarea.addEventListener('input', function() {
                            currentAssessment.answers[question.id] = this.value;
                            updateAssessmentButtons();
                        });
                    }
                    break;
                    
                default:
                    // שאלות רגילות
                    const inputs = document.querySelectorAll(`input[name="question_${question.id}"]`);
                    inputs.forEach(input => {
                        input.addEventListener('change', function() {
                            currentAssessment.answers[question.id] = parseInt(this.value);
                            updateAssessmentButtons();
                        });
                    });
                    break;
            }
        }

        function updateAssessmentProgress() {
            const progressEl = document.getElementById('assessmentProgress');
            if (!progressEl) return;
            
            const progress = ((currentAssessment.currentQuestion + 1) / weeklyQuestions.length) * 100;
            progressEl.style.width = Math.round(progress) + '%';
        }

        function updateAssessmentButtons() {
            const prevBtn = document.getElementById('prevQuestion');
            const nextBtn = document.getElementById('nextQuestion');
            
            if (!prevBtn || !nextBtn) return;
            
            // כפתור קודם
            prevBtn.disabled = currentAssessment.currentQuestion === 0;
            
            // בדיקה אם השאלה הנוכחית נענתה
            const currentQuestion = weeklyQuestions[currentAssessment.currentQuestion];
            let hasAnswer = false;
            
            switch(currentQuestion.type) {
                case 'weight':
                case 'input':
                    hasAnswer = currentAssessment.answers[currentQuestion.id] && 
                               currentAssessment.answers[currentQuestion.id].toString().trim() !== '';
                    break;
                    
                case 'time':
                    hasAnswer = currentAssessment.answers[currentQuestion.id] &&
                               currentAssessment.answers[currentQuestion.id].bedtime &&
                               currentAssessment.answers[currentQuestion.id].waketime;
                    break;
                    
                case 'checkbox':
                    hasAnswer = currentAssessment.answers[currentQuestion.id] && 
                               currentAssessment.answers[currentQuestion.id].length > 0;
                    break;
                    
                case 'conditional':
                    hasAnswer = currentAssessment.answers[currentQuestion.id] !== undefined;
                    break;
                    
                case 'textarea':
                    // שאלות אופציונליות
                    if (currentQuestion.optional) {
                        hasAnswer = true;
                    } else {
                        hasAnswer = currentAssessment.answers[currentQuestion.id] && 
                                   currentAssessment.answers[currentQuestion.id].trim() !== '';
                    }
                    break;
                    
                default:
                    hasAnswer = currentAssessment.answers[currentQuestion.id] !== undefined;
                    break;
            }
            
            // כפתור הבא
            if (currentAssessment.currentQuestion === weeklyQuestions.length - 1) {
                nextBtn.textContent = 'סיום השאלון 🎉';
                nextBtn.disabled = !hasAnswer;
            } else {
                nextBtn.textContent = 'הבאה ←';
                nextBtn.disabled = !hasAnswer;
            }
        }

        function nextQuestion() {
            if (currentAssessment.currentQuestion < weeklyQuestions.length - 1) {
                currentAssessment.currentQuestion++;
                displayCurrentQuestion();
                updateAssessmentProgress();
                updateAssessmentButtons();
            } else {
                // סיום השאלון
                completeAssessment();
            }
        }

        function prevQuestion() {
            if (currentAssessment.currentQuestion > 0) {
                currentAssessment.currentQuestion--;
                displayCurrentQuestion();
                updateAssessmentProgress();
                updateAssessmentButtons();
            }
        }

        function completeAssessment() {
            // שמירת ההערכה
            const athleteData = appData.athletes[currentUser.name];
            if (athleteData) {
                const assessmentData = {
                    date: new Date().toISOString().split('T')[0],
                    answers: { ...currentAssessment.answers },
                    completed_at: new Date().toISOString()
                };
                
                athleteData.assessments.push(assessmentData);
                
                // אם יש משקל בהערכה, להוסיף גם לרשימת המשקלים
                if (currentAssessment.answers[0]) {
                    const weightEntry = {
                        date: new Date().toISOString().split('T')[0],
                        weight: parseFloat(currentAssessment.answers[0]),
                        timing: "הערכה שבועית",
                        notes: "נמדד במסגרת הערכה שבועית"
                    };
                    athleteData.weights.push(weightEntry);
                }
                
                // עדכון המשימה כהושלמה
                const assessmentTask = athleteData.tasks.find(t => t.name.includes('הערכה שבועית'));
                if (assessmentTask) {
                    assessmentTask.completed = true;
                }
                
                saveData('athleteData', appData.athletes);
            }
            
            // הצגת סיכום השאלון
            showAssessmentSummary();
        }

        function showAssessmentSummary() {
            const container = document.getElementById('assessmentContainer');
            if (!container) return;
            
            // יצירת סיכום מקצועי
            const summaryHtml = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">🎉</div>
                    <h2 style="color: var(--primary-blue); margin-bottom: 16px;">השאלון הושלם בהצלחה!</h2>
                    <p style="color: var(--gray-600); margin-bottom: 24px;">המידע שלך נשמר ויעזור לנו לעקוב אחרי התקדמותך ולהתאים לך ליווי אישי ומדויק.</p>
                    
                    <div class="card" style="margin: 24px 0; text-align: right;">
                        <div class="card-header">סיכום מהיר</div>
                        <div style="font-size: 14px; line-height: 1.6;">
                            ${generateAssessmentSummary()}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button class="btn btn-primary nav-btn" data-screen="athleteHome" style="flex: 1;">
                            🏠 חזרה לדף הבית
                        </button>
                        <button class="btn btn-secondary nav-btn" data-screen="chat" style="flex: 1;">
                            💬 שתף עם המאמן
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = summaryHtml;
            
            // הוספת event listeners לכפתורים החדשים
            setTimeout(() => {
                const navButtons = container.querySelectorAll('.nav-btn');
                navButtons.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        const screen = this.dataset.screen;
                        showScreen(screen);
                    });
                });
            }, 100);
            
            // הסתרת כפתורי הניווט
            document.getElementById('prevQuestion').style.display = 'none';
            document.getElementById('nextQuestion').style.display = 'none';
            
            // איפוס השאלון אחרי 5 שניות
            setTimeout(() => {
                currentAssessment = {
                    currentQuestion: 0,
                    answers: {},
                    isCompleted: false
                };
            }, 5000);
        }

        function generateAssessmentSummary() {
            const answers = currentAssessment.answers;
            let summary = '';
            
            // משקל
            if (answers[0]) {
                summary += `• משקל הבוקר: ${answers[0]} ק"ג<br>`;
            }
            
            // שעות שינה
            if (answers[1]) {
                const sleepTexts = {1: 'פחות מ-6', 2: '6-7', 3: '7-8', 4: 'יותר מ-8'};
                summary += `• שעות שינה: ${sleepTexts[answers[1]]} שעות<br>`;
            }
            
            // איכות שינה
            if (answers[2]) {
                summary += `• איכות שינה: ${answers[2]}/5<br>`;
            }
            
            // מים
            if (answers[5]) {
                summary += `• צריכת מים: ${answers[5]} ליטר ביום<br>`;
            }
            
            // תוספים
            if (answers[6] && answers[6].length > 0) {
                summary += `• תוספי תזונה: ${answers[6].length} סוגים<br>`;
            }
            
            // מצב רוח
            if (answers[9]) {
                summary += `• מצב רוח: ${answers[9]}/5<br>`;
            }
            
            // אנרגיה
            if (answers[10]) {
                summary += `• רמת אנרגיה: ${answers[10]}/5<br>`;
            }
            
            if (summary === '') {
                summary = 'תודה על מילוי השאלון!';
            }
            
            return summary;
        }

        // ========== פונקציות עזר ==========

        function calculateDaysToCompetition(competitionDate) {
            const today = new Date();
            const competition = new Date(competitionDate);
            const diffTime = competition - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function updateWeightChart() {
            console.log('Weight chart would be updated here');
            
            // הצגה/הסתרה של שדה מלל חופשי
            const timingSelect = document.getElementById('weightTiming');
            const freeTextGroup = document.getElementById('freeTextGroup');
            
            if (timingSelect && freeTextGroup) {
                timingSelect.addEventListener('change', function() {
                    if (this.value === 'מלל חופשי') {
                        freeTextGroup.style.display = 'block';
                    } else {
                        freeTextGroup.style.display = 'none';
                    }
                });
            }
        }

        // ========== ניהול נתונים ==========

        function saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                console.log(`Data saved: ${key}`);
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        function loadData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error loading data:', error);
                return null;
            }
        }

        function addWeight(weight, timing, notes = '') {
            if (currentUser.role !== 'athlete') return;
            
            const athleteData = appData.athletes[currentUser.name];
            if (!athleteData) return;
            
            const finalNotes = timing === 'מלל חופשי' ? notes : timing;
            
            const newEntry = {
                date: new Date().toISOString().split('T')[0],
                weight: parseFloat(weight),
                timing: timing,
                notes: finalNotes
            };
            
            athleteData.weights.push(newEntry);
            saveData('athleteData', appData.athletes);
            
            // עדכון UI
            updateAthleteHome();
            
            // הצגת הודעת הצלחה
            alert('💪 המשקל נשמר בהצלחה!');
            
            // מעבר לדף הבית
            showScreen('athleteHome');
            
            console.log('Weight added:', newEntry);
        }

        // ========== אתחול אפליקציה ==========

        function initializeApp() {
            console.log('🥋 JudoNutrition App initialized');
            
            // טעינת נתונים שמורים
            const savedRole = localStorage.getItem('userRole');
            const savedAthleteData = loadData('athleteData');
            const savedNutritionistData = loadData('nutritionistData');
            
            if (savedAthleteData) {
                appData.athletes = savedAthleteData;
            }
            
            if (savedNutritionistData) {
                appData.nutritionist = savedNutritionistData;
            }
            
            // אתחול צ'אט
            initializeChat();
            
            // אם יש תפקיד שמור, הצגת המסך המתאים
            if (savedRole) {
                currentUser.role = savedRole;
                selectRole(savedRole);
            } else {
                showScreen('welcome');
            }
            
            // הוספת event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // כפתורי ניווטיציה
            document.addEventListener('click', function(e) {
                console.log('Click detected on:', e.target);
                
                // כפתורי תפקיד
                if (e.target.classList.contains('role-btn') || e.target.closest('.role-btn')) {
                    const btn = e.target.classList.contains('role-btn') ? e.target : e.target.closest('.role-btn');
                    const role = btn.dataset.role;
                    console.log('Role button clicked:', role);
                    selectRole(role);
                }
                
                // כפתורי ניווט
                if (e.target.classList.contains('nav-btn') || e.target.closest('.nav-btn')) {
                    e.preventDefault();
                    const btn = e.target.classList.contains('nav-btn') ? e.target : e.target.closest('.nav-btn');
                    const screen = btn.dataset.screen;
                    console.log('Nav button clicked:', screen);
                    showScreen(screen);
                }
                
                // כפתורי שאלון
                if (e.target.id === 'nextQuestion') {
                    nextQuestion();
                }
                if (e.target.id === 'prevQuestion') {
                    prevQuestion();
                }
                
                // כפתורי צ'אט
                if (e.target.id === 'athleteSendBtn') {
                    const input = document.getElementById('athleteChatInput');
                    if (input && input.value.trim()) {
                        sendMessage(input.value, 'chat');
                        input.value = '';
                    }
                }
                
                if (e.target.id === 'nutritionistSendBtn') {
                    const input = document.getElementById('nutritionistChatInput');
                    if (input && input.value.trim()) {
                        sendMessage(input.value, 'nutritionistChat');
                        input.value = '';
                    }
                }
            });
            
            // Enter key בשדות צ'אט
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (e.target.id === 'athleteChatInput') {
                        document.getElementById('athleteSendBtn').click();
                    }
                    if (e.target.id === 'nutritionistChatInput') {
                        document.getElementById('nutritionistSendBtn').click();
                    }
                }
            });
            
            // טופס הזנת משקל
            const weightForm = document.getElementById('weightForm');
            if (weightForm) {
                weightForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const weight = document.getElementById('weightInput').value;
                    const timing = document.getElementById('weightTiming').value;
                    const notes = document.getElementById('weightNotes').value;
                    addWeight(weight, timing, notes);
                    
                    // איפוס הטופס
                    this.reset();
                    document.getElementById('freeTextGroup').style.display = 'none';
                });
            }
        }

        // התחלת האפליקציה כשהדף נטען
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Export functions for global access
        window.JudoApp = {
            showScreen,
            selectRole,
            addWeight,
            saveData,
            loadData,
            exitToWelcome,
            nextQuestion,
            prevQuestion
        };
    </script>
</body>
</html>
